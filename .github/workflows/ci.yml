name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - 'README.md'
      - 'CHANGELOG.md'

jobs:
  test:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install coreutils for timeout
        run: brew install coreutils

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/project.pbxproj') }}
          restore-keys: |
            ${{ runner.os }}-spm-
            
      - name: Cache DerivedData
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('Sources/**/*.swift', 'Tests/**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: Boot simulator
        run: |
          echo "Available iPhone simulators:"
          xcrun simctl list devices available | grep iPhone
          
          # Try iPhone 17 first, fallback to iPhone 16 if not available
          if xcrun simctl list devices available | grep -q "iPhone 17"; then
            echo "Booting iPhone 17 simulator..."
            xcrun simctl boot "iPhone 17" || true
            SIMULATOR="iPhone 17"
          else
            echo "iPhone 17 not available, using iPhone 16..."
            xcrun simctl boot "iPhone 16" || true
            SIMULATOR="iPhone 16"
          fi
          
          echo "Waiting for simulator to be ready..."
          sleep 10
          echo "Simulator status:"
          xcrun simctl list devices | grep "$SIMULATOR"

      - name: Resolve packages
        run: xcodebuild -resolvePackageDependencies -project CrownAndBarrel.xcodeproj

      - name: Debug environment
        run: |
          echo "=== Environment Debug ==="
          echo "Xcode version:"
          xcodebuild -version
          echo "Available SDKs:"
          xcodebuild -showsdks
          echo "Available destinations:"
          xcodebuild -showdestinations -scheme "CrownAndBarrel" -project CrownAndBarrel.xcodeproj
          echo "Simulator processes:"
          ps aux | grep Simulator || echo "No Simulator processes"
          echo "Memory usage:"
          vm_stat
          echo "Disk space:"
          df -h

      - name: Run unit tests only
        run: |
          echo "Starting unit tests..."
          
          # Determine which simulator to use (same logic as boot step)
          if xcrun simctl list devices available | grep -q "iPhone 17"; then
            SIMULATOR="iPhone 17"
          else
            SIMULATOR="iPhone 16"
          fi
          
          echo "Using simulator: $SIMULATOR"
          echo "Testing simulator boot status:"
          xcrun simctl list devices | grep "$SIMULATOR"
          
          echo "Checking project and scheme..."
          xcodebuild -list -project CrownAndBarrel.xcodeproj
          
          echo "Testing basic build first..."
          xcodebuild build -project CrownAndBarrel.xcodeproj -scheme "CrownAndBarrel" -destination "platform=iOS Simulator,name=$SIMULATOR" -quiet
          
          echo "Running unit tests with verbose output and timeout..."
          # Remove -quiet to see what's happening, add timeout
          timeout 300 xcodebuild test -project CrownAndBarrel.xcodeproj -scheme "CrownAndBarrel" -destination "platform=iOS Simulator,name=$SIMULATOR" -only-testing:CrownAndBarrelTests -disableAutomaticPackageResolution
          
          echo "Unit tests completed successfully!"